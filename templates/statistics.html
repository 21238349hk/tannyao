<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="../static/statistics.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <h1>ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

        <div class="chart-grid">
            <div class="chart-section">
                <h2>ğŸ“Œ ä»Šé€±ã®ç§‘ç›®åˆ¥å‹‰å¼·æ™‚é–“</h2>
                <canvas id="subjectChart"></canvas>
            </div>

            <div class="chart-section">
                <h2>ğŸ“Œ é€±åˆ¥å‹‰å¼·æ™‚é–“ï¼ˆç›´è¿‘5é€±é–“ï¼‰</h2>
                <canvas id="weeklyChart"></canvas>
            </div>

            <div class="chart-section">
                <h2>ğŸ“Œ æœˆåˆ¥å‹‰å¼·æ™‚é–“ï¼ˆç›´è¿‘5ãƒ¶æœˆï¼‰</h2>
                <canvas id="monthlyChart"></canvas>
            </div>

            <div class="chart-section">
                <h2>ğŸ“Œ å…¨æœŸé–“ã®ç§‘ç›®åˆ¥å‰²åˆ</h2>
                <canvas id="overallPieChart"></canvas>
            </div>
        </div>

        <a href="{{ url_for('index') }}" class="back-button">â¬… æˆ»ã‚‹</a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const studyRecords = {{ study_records | tojson }};

            const today = new Date();
            const thisWeekStart = new Date(today.setDate(today.getDate() - today.getDay())); // æ—¥æ›œæ—¥å§‹ã¾ã‚Š

            let thisWeekSubjects = {};
            let weeklyTotals = {};
            let monthlyTotals = {};
            let overallSubjects = {};

            studyRecords.forEach(record => {
                const date = new Date(record.date);
                const subject = record.subject;
                const hours = parseFloat(record.hours);

                // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿
                if (date >= thisWeekStart) {
                    thisWeekSubjects[subject] = (thisWeekSubjects[subject] || 0) + hours;
                }

                // é€±åˆ¥ã‚­ãƒ¼ï¼šyyyy-Wxx
                const weekYear = date.getFullYear();
                const weekMonth = date.getMonth() + 1;
                const weekKey = `${weekYear}-${String(weekMonth).padStart(2, '0')}-W${Math.ceil(date.getDate() / 7)}`;
                weeklyTotals[weekKey] = (weeklyTotals[weekKey] || 0) + hours;

                // æœˆåˆ¥ã‚­ãƒ¼
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyTotals[monthKey] = (monthlyTotals[monthKey] || 0) + hours;

                // å…¨æœŸé–“ç§‘ç›®é›†è¨ˆ
                overallSubjects[subject] = (overallSubjects[subject] || 0) + hours;
            });

            // æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆï¼†5ä»¶å–å¾—
            function getRecentKeys(data, count) {
                return Object.keys(data).sort().slice(-count);
            }

            function createBarChart(canvasId, labels, data, labelText, color) {
                new Chart(document.getElementById(canvasId), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: labelText,
                            data,
                            backgroundColor: color
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            function createPieChart(canvasId, labels, data) {
                new Chart(document.getElementById(canvasId), {
                    type: 'pie',
                    data: {
                        labels,
                        datasets: [{
                            data,
                            backgroundColor: ['#4CAF50', '#FF9800', '#2196F3', '#9C27B0', '#FF5722', '#00BCD4']
                        }]
                    },
                    options: {
                        responsive: true,
                    }
                });
            }

            // ã‚°ãƒ©ãƒ•æç”»
            createBarChart("subjectChart", Object.keys(thisWeekSubjects), Object.values(thisWeekSubjects), "ä»Šé€±ã®å‹‰å¼·æ™‚é–“", "#42a5f5");

            const weeklyKeys = getRecentKeys(weeklyTotals, 5);
            createBarChart("weeklyChart", weeklyKeys, weeklyKeys.map(k => weeklyTotals[k]), "é€±åˆ¥å‹‰å¼·æ™‚é–“", "#66bb6a");

            const monthlyKeys = getRecentKeys(monthlyTotals, 5);
            createBarChart("monthlyChart", monthlyKeys, monthlyKeys.map(k => monthlyTotals[k]), "æœˆåˆ¥å‹‰å¼·æ™‚é–“", "#ffa726");

            createPieChart("overallPieChart", Object.keys(overallSubjects), Object.values(overallSubjects));
        });
    </script>
</body>
</html>
