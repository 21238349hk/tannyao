<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‰å¼·è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <link rel="stylesheet" href="../static/study_history.css">
</head>
<body>
    <div class="container">
        <!-- å·¦å´ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="calendar-container">
            <h1>ğŸ“… å‹‰å¼·è¨˜éŒ²</h1>
            <div class="calendar-header">
                <button id="prev-month">â—€</button>
                <h2 id="current-month"></h2>
                <button id="next-month">â–¶</button>
            </div>
            <div class="weekday-row">
                <div class="weekday">æ—¥</div>
                <div class="weekday">æœˆ</div>
                <div class="weekday">ç«</div>
                <div class="weekday">æ°´</div>
                <div class="weekday">æœ¨</div>
                <div class="weekday">é‡‘</div>
                <div class="weekday">åœŸ</div>
            </div>
            <div id="calendar"></div>
        </div>

        <!-- å³å´ã®å‹‰å¼·è¨˜éŒ²å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="study-form-container">
            <h2 id="selected-date">æ—¥ä»˜ã‚’é¸æŠ</h2>

            <label for="study-subject">ç§‘ç›®:</label>
            <select id="study-subject">
                <option value="æ•°å­¦">æ•°å­¦</option>
                <option value="è‹±èª">è‹±èª</option>
                <option value="ç†ç§‘">ç†ç§‘</option>
                <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
                <option value="å›½èª">å›½èª</option>
                <option value="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>

            <!-- ãã®ä»–ã®ç§‘ç›®ç”¨ã®å…¥åŠ›æ¬„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
            <input type="text" id="custom-subject" placeholder="ç§‘ç›®ã‚’å…¥åŠ›" style="display: none;">

            <label>å‹‰å¼·æ™‚é–“ï¼ˆæ™‚é–“ï¼‰:</label>
            <input type="number" id="study-hours" min="0" step="0.5" placeholder="ä¾‹: 2">
            <button id="add-study">è¿½åŠ </button>

            <h3>ğŸ“œ è¨˜éŒ²ä¸€è¦§</h3>
            <ul id="study-list">
                {% for record in study_records %}
                    <li data-date="{{ record.date }}">
                        <strong>{{ record.date }} - {{ record.subject }}</strong>: {{ record.hours }} æ™‚é–“
                    </li>
                {% endfor %}
            </ul>

            <!--éŸ³å£°èªè­˜ã®è¦ç´„ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºâ€»åˆ¥é€”è¿½åŠ éƒ¨åˆ†-->>

            <h3>å‹‰å¼·å†…å®¹âœ</h3>
            <ul id="study-notes-list">
                {% for note in study_notes %}
                    <li class="note-item" data-id="{{ note.id }}">
                        <div class="note-info">
                            <strong>ç§‘ç›®:</strong> {{ note.subject }} <br>
                            <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> {{ note.title }} <br>
                            <strong>è¦ç´„:</strong> {{ note.summary }} <br>
                            <em>ä¿å­˜æ—¥æ™‚: {{ note.created_at }}</em>
                        </div>
                        <button class="delete-note-btn" onclick="deleteStudyNote('{{ note.id }}')">âŒ</button>
                    </li>
                {% endfor %}
            </ul>
            
            

            <!--éŸ³å£°èªè­˜ã®è¦ç´„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤-->>

            <script>
                async function deleteStudyNote(noteId) {
                    if (!confirm("æœ¬å½“ã«ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            
                    try {
                        let response = await fetch("/delete_study_note", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ note_id: noteId }),
                        });
            
                        let result = await response.json();
                        if (result.success) {
                            alert(result.message);
                            location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å‰Šé™¤ã‚’åæ˜ 
                        } else {
                            alert("å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + result.error);
                        }
                    } catch (error) {
                        console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                    }
                }
            </script>

        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
    const calendar = document.getElementById("calendar");
    const currentMonth = document.getElementById("current-month");
    const prevMonthBtn = document.getElementById("prev-month");
    const nextMonthBtn = document.getElementById("next-month");

    const selectedDateText = document.getElementById("selected-date");
    const studySubjectSelect = document.getElementById("study-subject"); // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    const studyHoursInput = document.getElementById("study-hours");
    const addStudyButton = document.getElementById("add-study");
    const studyList = document.getElementById("study-list");

    let today = new Date();
    let currentYear = today.getFullYear();
    let currentMonthIndex = today.getMonth();
    let selectedDate = null;

    function renderCalendar(year, month) {
        calendar.innerHTML = ""; 
        currentMonth.innerText = `${year}å¹´ ${month + 1}æœˆ`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            let emptyDiv = document.createElement("div");
            emptyDiv.classList.add("empty-day");
            calendar.appendChild(emptyDiv);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            let dayDiv = document.createElement("div");
            dayDiv.classList.add("calendar-day");
            dayDiv.innerText = i;

            dayDiv.addEventListener("click", () => {
                selectedDate = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                selectedDateText.innerText = `${year}å¹´${month + 1}æœˆ${i}æ—¥ ã®å‹‰å¼·è¨˜éŒ²`;

                fetchStudyRecords(selectedDate);
            });

            calendar.appendChild(dayDiv);
        }
    }

    async function fetchStudyRecords(date) {
        try {
            let response = await fetch(`/get_study_records?date=${date}`);
            let result = await response.json();

            if (result.success) {
                studyList.innerHTML = "";
                result.records.forEach(record => {
                    let li = document.createElement("li");
                    li.innerHTML = `<strong>${record.subject}</strong>: ${record.hours}æ™‚é–“`;
                    li.dataset.date = date;
                    studyList.appendChild(li);
                });
            }
        } catch (error) {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
        }
    }

    addStudyButton.addEventListener("click", async () => {
        if (!selectedDate) {
            alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
            return;
        }

        let subject = studySubjectSelect.value;  
        let hours = studyHoursInput.value.trim();

        if (hours === "") {
            alert("å‹‰å¼·æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
            return;
        }

        try {
            let response = await fetch("/study_history", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ date: selectedDate, subject, hours }),
            });

            let result = await response.json();
            if (result.success) {
                fetchStudyRecords(selectedDate);
                studyHoursInput.value = "";
            } else {
                alert(result.error);
            }
        } catch (error) {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        }
    });

    prevMonthBtn.addEventListener("click", function () {
        currentMonthIndex--;
        if (currentMonthIndex < 0) {
            currentMonthIndex = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonthIndex);
    });

    nextMonthBtn.addEventListener("click", function () {
        currentMonthIndex++;
        if (currentMonthIndex > 11) {
            currentMonthIndex = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonthIndex);
    });

    renderCalendar(currentYear, currentMonthIndex);
});

    </script>
    
</body>
</html>
